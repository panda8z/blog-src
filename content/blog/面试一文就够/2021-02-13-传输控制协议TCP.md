---
slug: tcp-note
title: 传输控制协议TCP
date: 2021-02-13 22:01:49
type: blog
---

## 1. 计算机网络中的TCP

### 1.1 开放系统互连参考模型的发展

在计算机网络的发展过程中人们逐渐总结出了一套分层次的计算机网络体系结构，称为 **开放系统互连参考模型**。

1974年，美国的IBM公司宣布了系统网络体系结构SNA (System Network Architecture)。这个著名的网络标准就是按照分层的方法制定的。现在用IBM大型机构建的专用网络仍在使用SNA。不久后，其他一些公司也相继推出自己公司的具有不同名称的体系结构。不同的网络体系结构出现后，使用同一个公司生产的各种设备都能够很容易地互连成网。这种情况显然有利于一个公司垄断市场。用户一旦购买了某个公司的网络，当需要扩大容量时，就只能再购买原公司的产品。如果购买了其他公司的产品，那么由于网络体系结构的不同，就很难互相连通。然而，全球经济的发展使得不同网络体系结构的用户迫切要求能够互相交换信息。为了使不同体系结构的计算机网络都能互连，国际标准化组织ISO于1977年成立了专门机构研究该问题。不久，他们就提出一个试图使各种计算机在世界范围内互连成网的标准框架，即著名的开放系统互连基本参考模型OSI/RM (Open Systems Interconnection Reference Model)，简称为OSI。“开放”是指非独家垄断的。

因此只要遵循OSI标准，一个系统就可以和位于世界上任何地方的、也遵循这同一标准的其他任何系统进行通信。这一点很像世界范围的电话和邮政系统，这两个系统都是开放系统。“系统”是指在现实的系统中与互连有关的各部分（我们知道，并不是一个系统中的所有部分都与互连有关。OSI/RM参考模型是把与互连无关的部分除外，而仅仅考虑与互连有关的那些部分）。所以开放系统互连参考模型OSI/RM是个抽象的概念。在1983年形成了开放系统互连基本参考模型的正式文件，即著名的ISO 7498国际标准，也就是所谓的七层协议的体系结构。
OSI试图达到一种理想境界，即全世界的计算机网络都遵循这个统一的标准，因而全世界的计算机将能够很方便地进行互连和交换数据。在20世纪80年代，许多大公司甚至一些国家的政府机构纷纷表示支持OSI。当时看来似乎在不久的将来全世界一定会按照OSI制定的标准来构造自己的计算机网络。然而到了20世纪90年代初期，虽然整套的OSI国际标准都已经制定出来了，但由于因特网已抢先在全世界覆盖了相当大的范围，而与此同时却几乎找不到有什么厂家生产出符合OSI标准的商用产品。因此人们得出这样的结论：OSI只获得了一些理论研究的成果，但在市场化方面OSI则事与愿违地失败了。现今规模最大的、覆盖全世界的因特网并未使用OSI标准。OSI失败的原因可归纳为：
- (1) OSI的专家们缺乏实际经验，他们在完成OSI标准时缺乏商业驱动力；
- (2) OSI的协议实现起来过分复杂，而且运行效率很低；
- (3) OSI标准的制定周期太长，因而使得按OSI标准生产的设备无法及时进入市场；
- (4) OSI的层次划分不太合理，有些功能在多个层次中重复出现。
- 
按照一般的概念，网络技术和设备只有符合有关的国际标准才能大范围地获得工程上的应用。但现在情况却反过来了。得到最广泛应用的不是法律上的国际标准 OSI，而是非国际标准TCP/IP。这样，TCP/IP就常被称为是事实上的国际标准。从这种意义上说，能够占领市场的就是标准。在过去制定标准的组织中往往以专家、学者为主。但现在许多公司都纷纷挤进各种各样的标准化组织，使得技术标准具有浓厚的商业气息。一个新标准的出现，有时不一定反映其技术水平是最先进的，而是往往有着一定的市场背景。

顺便说一下，虽然OSI标准在一开始是由ISO来制定，但后来的许多标准都是ISO与原来的国际电报电话咨询委员会CCITT联合制定的。从历史上来看，CCITT原来是从通信的角度考虑一些标准的制定，而ISO则关心信息的处理。但随着科学技术的发展，通信与信息处理的界限变得比较模糊了。于是，通信与信息处理就都成为CCITT与ISO所共同关心的领域。CCITT的建议书X.200就是关于开放系统互连参考模型，它和上面提到的ISO 7498基本上是相同的。

### 1.2 具有五层协议的体系结构

OSI的七层协议体系结构（图1-18(a)）的概念清楚，理论也较完整，但它既复杂又不实用。TCP/IP体系结构则不同，它现在已经得到了非常广泛的应用。

TCP/IP是一个四层的体系结构（图1-18(b)），它包含应用层、运输层、网际层和网络接口层（用网际层这个名字是强调这一层是为了解决不同网络的互连问题）。

不过从实质上讲，TCP/IP只有最上面的三层，因为最下面的网络接口层基本上和一般的通信链路在功能上没有多大差别，对于计算机网络来说，这一层并没有什么特别新的具体内容。

因此在学习计算机网络的原理时往往采取折中的办法，即综合OSI和TCP/IP的优点，采用一种只有五层协议的体系结构（图1-18(c)），这样既简洁又能将概念阐述清楚。

![picture 2](../../assets/2021-02-13-传输控制协议TCP/809012a784804751e186dae45f9b3bb5075f8608abcd46661589a258a13e13ea.png)  

现在结合因特网的情况，自上而下地、非常简要地介绍一下各层的主要功能。实际上，只有认真学习完本书各章的协议后才能真正弄清各层的作用。

#### (1) 应用层(application layer)
应用层是体系结构中的最高层。应用层的任务是通过应用进程间的交互来完成特定网络应用。应用层协议定义的是应用进程间通信和交互的规则。这里的进程(process)就是指主机中正在运行的程序。对于不同的网络应用需要有不同的应用层协议。在因特网中的应用层协议很多，如支持万维网应用的HTTP协议，支持电子邮件的SMTP协议，支持文件传送的FTP协议，等等。我们将应用层交互的数据单元称为报文(message)。

#### (2) 运输层(transport layer)

运输层的任务就是负责向两个主机中进程之间的通信提供通用的数据传输服务。应用进程利用该服务传送应用层报文。所谓通用，是指并不针对某个特定网络应用，而是多种应用可以使用同一个运输层服务。由于一台主机可同时运行多个进程，因此运输层有复用和分用的功能。复用就是多个应用层进程可同时使用下面运输层的服务，分用与复用相反，是运输层把收到的信息分别交付上面应用层中的相应进程。运输层主要使用以下两种协议：
- 传输控制协议TCP (Transmission Control Protocol)——提供面向连接的、可靠的数据传输服务，其数据传输的单位是报文段(segment)。
- 用户数据报协议 UDP (User Datagram Protocol)——提供无连接的、尽最大努力(best-effort)的数据传输服务（不保证数据传输的可靠性），其数据传输的单位是用户数据报。

#### (3) 网络层(network layer)

网络层负责为分组交换网上的不同主机提供通信服务。
在发送数据时，网络层把运输层产生的报文段或用户数据报封装成分组或包(packet)进行传送。

在TCP/IP体系中，由于网络层使用IP协议，因此分组也叫作 IP数据报，或简称为数据报(datagram)。
本书把“分组”和“数据报”作为同义词使用。
请注意：不要将运输层的“用户数据报UDP”和网络层的“IP数据报”弄混。
此外，无论在哪一层传送的数据单元，都可笼统地用“分组”来表示。
网络层的另一个任务就是要选择合适的路由，使源主机运输层所传下来的分组能够通过网络中的路由器找到目的主机。
这里要强调指出，网络层中的“网络”二字，已不是我们通常谈到的具体的网络，而是在计算机网络体系结构模型中的专用名词。

因特网是一个很大的互联网，它由大量的异构(heterogeneous)网络通过路由器(router)相互连接起来。
因特网主要的网络层协议是无连接的网际协议IP (Internet Protocol)和许多种路由选择协议，因此因特网的网络层也叫做网际层或IP层。
在本书中，网络层、网际层和IP层都是同义语。

#### (4) 数据链路层(data link layer)

数据链路层常简称为链路层。
我们知道，两台主机之间的数据传输，总是在一段一段的链路上传送的，这就需要使用专门的链路层的协议。
在两个相邻结点之间传送数据时，数据链路层将网络层交下来的IP数据报组装成帧（framing），在两个相邻结点间的链路上传送帧（frame）。
每一帧包括数据和必要的控制信息（如同步信息、地址信息、差错控制等）。
在接收数据时，控制信息使接收端能够知道一个帧从哪个比特开始和到哪个比特结束。
这样，数据链路层在收到一个帧后，就可从中提取出数据部分，上交给网络层。

控制信息还使接收端能够检测到所收到的帧中有无差错。
如发现有差错，数据链路层就简单地丢弃这个出了差错的帧，以免继续在网络中传送下去白白浪费网络资源。

如果需要改正数据在数据链路层传输时出现的差错（这就是说，数据链路层不仅要检错，而且要纠错），那么就要采用可靠传输协议来纠正出现的差错。
这种方法会使数据链路层的协议复杂些。

#### (5) 物理层(physical layer)

在物理层上所传数据的单位是比特。发送方发送1（或0）时，接收方应当收到1（或0）而不是0（或1）。因此物理层要考虑用多大的电压代表“1”或“0”，以及接收方如何识别出发送方所发送的比特。

物理层还要确定连接电缆的插头应当有多少根引脚以及各条引脚应如何连接。当然，解释比特代表的意思，就不是物理层的任务。请注意，传递信息所利用的一些物理媒体，如双绞线、同轴电缆、光缆、无线信道等，并不在物理层协议之内而是在物理层协议的下面。因此也有人把物理媒体当作第0层。

在因特网所使用的各种协议中，最重要的和最著名的就是TCP和IP两个协议。现在人们经常提到的TCP/IP并不一定是单指TCP和IP这两个具体的协议，而往往是表示因特网所使用的整个TCP/IP协议族(protocol suite)。图1-19说明的是应用进程的数据在各层之间的传递过程中所经历的变化。这里为简单起见，假定两台主机通过一台路由器连接起来。

![picture 3](../../assets/2021-02-13-传输控制协议TCP/1a0de36d75acb53fdc8ec1d37e2ec99b3384fc26652d6dd634c57eda453dc756.png)  

假定主机1的应用进程 AP1（Application1）向主机2的应用进程 AP2（Application2）传送数据。AP1先将其数据交给本主机的第5层（应用层）。第5层加上必要的控制信息 H5（Header5）就变成了下一层的数据单元。
第4层（运输层）收到这个数据单元后，加上本层的控制信息 H4（Header4），再交给第3层（网络层），成为第3层的数据单元。
依此类推。不过到了第2层（数据链路层）后，控制信息被分成两部分，分别加到本层数据单元的首部 \[H2（Header2）]和尾部 \[T2（Tail2）]；而第1层（物理层）由于是比特流的传送，所以不再加上控制信息。
请注意，传送比特流时应从首部开始传送。

OSI参考模型把对等层次之间传送的数据单位称为该层的协议数据单元 PDU (Protocol Data Unit)。这个名词现已被许多非OSI标准采用。当这一串的比特流离开主机1的物理层经网络的物理媒体（传输信道）传送到路由器时，就从路由器的第1层（物理层）依次上升到第3层（网络层）。每一层都是根据控制信息进行必要的操作，然后将控制信息剥去，将该层剩下的数据单元上交给更高的一层。当分组上升到了第3层时，就根据首部中的目的地址查找路由器中的路由表，找出转发分组的接口，然后往下传送到第2层（链路层），加上新的首部和尾部后，再到最下面的第1层，然后在物理媒体上把每一个比特发送出去。

当这一串的比特流离开路由器到达目的站主机2时，就从主机2的第1层按照上面讲过的方式，依次上升到第5层。最后，把应用进程AP1发送的数据交给目的站的应用进程AP2。

可以用一个简单例子来比喻上述过程。有一封信从最高层向下传。每经过一层就包上一个新的信封，写上必要的、交由下一层处理的地址信息。包有多个信封的信件传送到目的站后，从第1层起，每层拆开一个信封后（即按协议进行处理后）就把信封中的信交给它的上一层。传到最高层后，取出发信人所发的信交给收信人。

虽然应用进程数据要经过如图1-19所示的复杂过程才能送到终点的应用进程，但这些复杂过程对用户来说，却都被屏蔽掉了，以致应用进程AP1 觉得好像是直接把数据交给了应用进程AP2。同理，任何两个同样的层次（例如在两个系统的第4层）之间，也好像如同图1-19中的水平虚线所示的那样，把数据（即数据单元加上控制信息）通过水平虚线直接传递给对方。这就是所谓的“对等层”(peerlayers)之间的通信。

我们以前经常提到的各层协议，实际上就是在各个对等层之间传递数据时的各项规定。在文献中也还可以见到术语“协议栈”(protocol stack)。这是因为几个层次画在一起很像一个栈(stack)的结构。

### 1.3 实体、协议、服务和服务访问点
当研究开放系统中的信息交换时，往往使用 **实体(entity)** 这一较为抽象的名词表示**任何可发送或接收信息的硬件或软件进程**。
在许多情况下，实体就是一个特定的软件模块。

协议是控制两个对等实体（或多个实体）进行通信的规则的集合。
协议在语法方面的规则定义了所交换的信息的格式；而协议在语义方面的规则就定义了发送者或接收者所要完成的操作，例如，在何种条件下数据必须重传或丢弃；协议在同步方面的规则定义了收发双方的时序关系，即在一定条件下应当发生什么事件。

**在协议的控制下，两个对等实体间的通信使得本层能够向上一层提供服务。要实现本层协议，还需要使用下面一层所提供的服务。**

一定要弄清楚，协议和服务在概念上是很不一样的。
首先，协议的实现保证了能够向上一层提供服务。
**使用本层服务的实体只能看见服务而无法看见下面的协议**。
也就是说，下面的协议对上面的实体是透明的。

其次，**协议是“水平的”，即协议是控制对等实体之间通信的规则**。
但**服务是“垂直的”，即服务是由下层向上层通过层间接口提供的**。
另外，并非在一个层内完成的全部功能都称为服务。
只有那些能够被高一层实体“看得见”的功能才能称之为“服务”。
上层使用下层所提供的服务必须通过与下层交换一些命令，这些命令在OSI中称为服务原语。
在同一系统中相邻两层的实体进行交互(即交换信息)的地方，通常称为**服务访问点 SAP (ServiceAccess Point)**。
服务访问点SAP是一个抽象的概念，它实际上就是一个逻辑接口，有点像邮政信箱（可以把邮件放入信箱和从信箱中取走邮件），但这种层间接口和两个设备之间的硬件接口（并行的或串行的）并不一样。
OSI把层与层之间交换的数据的单位称为**服务数据单元SDU (Service DataUnit)**，它可以与协议数据单元PDU不一样。
例如，可以是多个SDU合成为一个PDU，也可以是一个SDU划分为几个PDU。
这样，在任何相邻两层之间的关系可概括为图1-20所示的那样。
这里要注意的是，第n层的两个“实体(n)”之间通过“协议(n)”进行通信，而第n + 1层的两个“实体(n + 1)”之间则通过另外的“协议(n + 1)”进行通信（每一层都使用不同的协议）。第n层向上面的第n + 1层所提供的服务实际上已包括了在它以下各层所提供的服务。第n层的实体对第n + 1层的实体就相当于一个服务提供者。在服务提供者的上一层的实体又称为“服务用户”，因为它使用下层服务提供者所提供的服务。

![picture 4](../../assets/2021-02-13-传输控制协议TCP/863f23718ee247baf7f49c0836aa5c5ecc251d2bf635734ca95c8a663f76531a.png)  

计算机网络的协议还有一个很重要的特点，就是协议必须把所有不利的条件事先都估计到，而不能假定一切都是正常的和非常理想的。
例如，两个朋友在电话中约好，下午3时在某公园门口碰头，并且约定“不见不散”。
这就是一个很不科学的协议，因为任何一方临时有急事来不了而又无法通知对方时（如对方的电话或手机都无法接通），则另一方按照协议就必须永远等待下去。
因此，看一个计算机网络协议是否正确，不能只看在正常情况下是否正确，而且还必须非常仔细地检查这个协议能否应付各种异常情况。

### 1.4 TCP/IP的体系结构

前面已经说过，TCP/IP的体系结构比较简单，它只有四层。图1-22给出了用这种四层协议表示方法的例子。请注意，图中的路由器在转发分组时最高只用到网络层而没有使用运输层和应用层。

![picture 5](../../assets/2021-02-13-传输控制协议TCP/433f66e3acde39602e71db2a44b0a7ab46023b02f302241acb867303292128c9.png)  

应当指出，技术的发展并不是遵循严格的OSI分层的概念。实际上现在的因特网使用的TCP/IP体系结构有时已经演变成为图1-23所示的那样，即某些应用程序可以直接使用IP层，或直接使用最下面的网络接口层[PETE11]，图1-23是这种表示方法。在图中，网络接口层有时也称为子网层。但本书不采用“子网层”这种容易混淆的表示方法，因为这里的“子网”是指一些局域网和某些广域网（如ATM网），但从IP层来看，这些网络属于数据链路层，也就是属于网络接口层。我们在第4章4.3.1节，将会讲到“子网划分”。但子网划分中的“子网”和图1-23中“子网层”中的“子网”是完全不同的概念。

![picture 6](../../assets/2021-02-13-传输控制协议TCP/3f85488b16609578a17f426aa7fc69f75b656c64611710307a7b8a7b23cca471.png)  

还有一种方法，就是分层次画出具体的协议来表示TCP/IP协议族（图1-24），它的特点是上下两头大而中间小：应用层和网络接口层都有多种协议，而中间的IP层很小，上层的各种协议都向下汇聚到一个IP协议中。
这种很像沙漏计时器形状的TCP/IP协议族表明：**TCP/IP协议可以为各式各样的应用提供服务**（所谓的everything over IP），同时**TCP/IP协议也允许IP协议在各式各样的网络构成的互联网上运行**（所谓的IP over everything）。
正因为如此，因特网才会发展到今天的这种全球规模。
从图1-24不难看出IP协议在因特网中的核心作用。

![picture 7](../../assets/2021-02-13-传输控制协议TCP/dbf3b2e892573c149673679277d5e79ce63fa78f81b5a489e9fcba0b68d53856.png)  

【例1-2】 利用协议栈的概念，说明在因特网中常用的客户-服务器工作方式。【解】图1-25中的主机A和主机B都各有自己的协议栈。主机A中的应用进程（即客户进程）的位置在最高的应用层。这个客户进程向主机B应用层的服务器进程发出请求，请求建立连接（图中的❶）。然后，主机B中的服务器进程接受A的客户进程发来的请求（图中的❷）。所有这些通信，实际上都需要使用下面各层所提供的服务。但若仅仅考虑客户进程和服务器进程的交互，则可把它们之间的交互看成是如图中的水平虚线所示的那样。

![picture 8](../../assets/2021-02-13-传输控制协议TCP/8e26330794e1cffc7bd05d011bd804befbf6d8783fb820c4e4714efc4a9b75cc.png)  

图1-26画出了三个主机的协议栈。主机C的应用层中同时有两个服务器进程在通信。服务器1在和主机A中的客户1通信，而服务器2在和主机B中的客户2通信。有的服务器进程可以同时向几百个客户进程提供服务。

![picture 9](../../assets/2021-02-13-传输控制协议TCP/84894141cc536fec5b2e88b960eeef0b5c3d8d5698ad9a02d0ff996ca972435b.png)  

### 1.5 本章的重要概念

-  计算机网络（可简称为网络）把许多计算机连接在一起，而互联网则把许多网络连接在一起，是网络的网络。因特网是世界上最大的互联网。
-  以小写字母i开始的internet（互联网或互连网）是通用名词，它泛指由多个计算机网络互连而成的网络。在这些网络之间的通信协议（即通信规则）可以是任意的。
-  以大写字母I开始的Internet（因特网）是专用名词，它指当前全球最大的、开放的、由众多网络相互连接而成的特定计算机网络，它采用TCP/IP协议族作为通信规则，且其前身是美国的ARPANET。
-  因特网现在采用存储转发的分组交换技术，以及三层因特网服务提供者（ISP）结构。
-  因特网按工作方式可划分为边缘部分与核心部分。主机在网络的边缘部分，其作用是进行信息处理。路由器在网络的核心部分，其作用是按存储转发方式进行分组交换。
-  计算机通信是计算机中的进程（即运行着的程序）之间的通信。计算机网络采用的通信方式是客户-服务器方式和对等连接方式（P2P方式）。
-  客户和服务器都是指通信中所涉及的两个应用进程。客户是服务请求方，服务器是服务提供方。
-  按作用范围的不同，计算机网络分为广域网WAN、城域网MAN、局域网LAN和个人区域网PAN。
-  计算机网络最常用的性能指标是：速率、带宽、吞吐量、时延（发送时延、传播时延、处理时延、排队时延）、时延带宽积、往返时间和信道（或网络）利用率。
-  网络协议即协议，是为进行网络中的数据交换而建立的规则。计算机网络的各层及其协议的集合，称为网络的体系结构。
-  五层协议的体系结构由应用层、运输层、网络层（或网际层）、数据链路层和物理层组成。运输层最重要的协议是传输控制协议TCP和用户数据报协议UDP，而网络层最重要的协议是网际协议IP。


## 2. 传输控制协议TCP

由于TCP协议比较复杂，因此本节先对TCP协议进行一般的介绍，然后再逐步深入讨论TCP的可靠传输、流量控制和拥塞控制等问题。

### 2.1 TCP最主要的特点
TCP是TCP/IP体系中非常复杂的一个协议。下面介绍TCP最主要的特点。

(1) TCP是面向连接的运输层协议。这就是说，应用程序在使用TCP协议之前，必须先建立TCP连接。在传送数据完毕后，必须释放已经建立的TCP连接。也就是说，应用进程之间的通信好像在“打电话”：通话前要先拨号建立连接，通话结束后要挂机释放连接。

(2) 每一条TCP连接只能有两个端点(endpoint)，每一条TCP连接只能是点对点的（一对一）。这个问题后面还要进一步讨论。

(3) TCP提供可靠交付的服务。通过TCP连接传送的数据，无差错、不丢失、不重复、并且按序到达。

(4) TCP提供全双工通信。TCP允许通信双方的应用进程在任何时候都能发送数据。TCP连接的两端都设有发送缓存和接收缓存，用来临时存放双向通信的数据。在发送时，应用程序在把数据传送给TCP的缓存后，就可以做自己的事，而TCP在合适的时候把数据发送出去。在接收时，TCP把收到的数据放入缓存，上层的应用进程在合适的时候读取缓存中的数据。

(5) 面向字节流。TCP中的“流”(stream)指的是流入到进程或从进程流出的字节序列。“面向字节流”的含义是：虽然应用程序和TCP的交互是一次一个数据块（大小不等），但TCP把应用程序交下来的数据看成仅仅是一连串的无结构的字节流。TCP并不知道所传送的字节流的含义。

TCP不保证接收方应用程序所收到的数据块和发送方应用程序所发出的数据块具有对应大小的关系（例如，发送方应用程序交给发送方的TCP共10个数据块，但接收方的TCP可能只用了4个数据块就把收到的字节流交付上层的应用程序）。
但接收方应用程序收到的字节流必须和发送方应用程序发出的字节流完全一样。
当然，接收方的应用程序必须有能力识别收到的字节流，把它还原成有意义的应用层数据。
图5-8是上述概念的示意图。

![图5-8 TCP面向流的概念](../../assets/2021-02-13-传输控制协议TCP/df748cde8d7ab45f8879a3e8244370d87fd3ccebf48758ea210300e05e4387cf.png)  

为了突出示意图的要点，我们只画出了一个方向的数据流。但请注意，在实际的网络中，一个TCP报文段包含上千个字节是很常见的，而图中的各部分都只画出了几个字节，这仅仅是为了更方便地说明“面向字节流”的概念。另一点很重要的是：图5-8中的TCP连接是一条虚连接（也就是逻辑连接）而不是一条真正的物理连接。TCP报文段先要传送到IP层，加上IP首部后，再传送到数据链路层。再加上数据链路层的首部和尾部后，才离开主机发送到物理链路。图5-8指出，TCP和UDP在发送报文时所采用的方式完全不同。TCP并不关心应用进程一次把多长的报文发送到TCP的缓存中，而是根据对方给出的窗口值和当前网络拥塞的程度来决定一个报文段应包含多少个字节（UDP发送的报文长度是应用进程给出的）。如果应用进程传送到TCP缓存的数据块太长，TCP就可以把它划分短一些再传送。如果应用进程一次只发来一个字节，TCP也可以等待积累有足够多的字节后再构成报文段发送出去。关于TCP报文段的长度问题，在后面还要进行讨论。
